> from rest_framework import viewsets, status, permissions
> from rest_framework.decorators import action
> from rest_framework.response import Response
  
> from opentelemetry import trace
  
> from .models import Cart, CartItem
> from .serializers import CartSerializer, CartItemSerializer
  
> from utils.otel_utils import add_span_event, record_span_error, set_span_attributes
> from utils.telemetry import api_error_counter, cart_add_counter, cart_remove_counter
  
  
> class CartViewSet(viewsets.ModelViewSet):
>     serializer_class = CartSerializer
>     permission_classes = [permissions.IsAuthenticated]
      
>     def get_queryset(self):
!         return Cart.objects.filter(user=self.request.user)
      
>     def get_object(self):
!         cart, created = Cart.objects.get_or_create(user=self.request.user)
!         return cart
      
>     @action(detail=False, methods=['post'])
>     def add_item(self, request):
>         """Add item to cart."""
>         cart, created = Cart.objects.get_or_create(user=request.user)
>         product_id = request.data.get('product')
>         variant_id = request.data.get('variant')
>         try:
>             quantity = int(request.data.get('quantity', 1))
!         except (TypeError, ValueError):
!             api_error_counter.add(1, {"endpoint": "cart.add_item", "reason": "invalid_quantity"})
!             record_span_error("validation_error", "Invalid quantity", {"endpoint": "cart.add_item"})
!             return Response({'error': 'Invalid quantity'}, status=status.HTTP_400_BAD_REQUEST)
  
>         if quantity <= 0:
!             api_error_counter.add(1, {"endpoint": "cart.add_item", "reason": "invalid_quantity"})
!             record_span_error("validation_error", "Invalid quantity", {"endpoint": "cart.add_item"})
!             return Response({'error': 'Invalid quantity'}, status=status.HTTP_400_BAD_REQUEST)
  
>         set_span_attributes(
>             {
>                 "app.operation": "cart.add_item",
>                 "user.id": request.user.id,
>                 "product.id": int(product_id) if str(product_id).isdigit() else product_id,
>                 "variant.id": int(variant_id) if str(variant_id).isdigit() else variant_id,
>                 "cart.item.quantity": quantity,
>             }
>         )
          
>         cart_item, created = CartItem.objects.get_or_create(
>             cart=cart,
>             product_id=product_id,
>             variant_id=variant_id,
>             defaults={'quantity': quantity}
>         )
          
>         if not created:
!             cart_item.quantity += quantity
!             cart_item.save()
  
>         cart_add_counter.add(
>             quantity,
>             {
>                 "endpoint": "cart.add_item",
>                 "has_variant": bool(variant_id),
>             },
>         )
>         add_span_event("cart.item_added", {"quantity": quantity})
          
>         serializer = CartSerializer(cart)
>         return Response(serializer.data)
      
>     @action(detail=False, methods=['post'])
>     def remove_item(self, request):
>         """Remove item from cart."""
>         item_id = request.data.get('item_id')
>         try:
>             cart_item = CartItem.objects.get(id=item_id, cart__user=request.user)
!             removed_quantity = int(cart_item.quantity or 0)
!             cart_item.delete()
  
!             cart_remove_counter.add(
!                 max(removed_quantity, 1),
!                 {
!                     "endpoint": "cart.remove_item",
!                 },
!             )
!             add_span_event("cart.item_removed", {"quantity": removed_quantity})
!             cart = Cart.objects.get(user=request.user)
!             serializer = CartSerializer(cart)
!             return Response(serializer.data)
>         except CartItem.DoesNotExist:
>             api_error_counter.add(1, {"endpoint": "cart.remove_item", "reason": "item_not_found"})
>             record_span_error("not_found", "Cart item not found", {"endpoint": "cart.remove_item"})
>             return Response({'error': 'Item not found'}, status=status.HTTP_404_NOT_FOUND)
  
>     @action(detail=False, methods=['post'])
>     def set_quantity(self, request):
>         """Set cart item quantity. If quantity is 0, deletes the item."""
>         item_id = request.data.get('item_id')
>         quantity_raw = request.data.get('quantity')
  
>         try:
>             quantity = int(quantity_raw)
!         except (TypeError, ValueError):
!             return Response({'error': 'Invalid quantity'}, status=status.HTTP_400_BAD_REQUEST)
  
>         if quantity < 0:
!             return Response({'error': 'Invalid quantity'}, status=status.HTTP_400_BAD_REQUEST)
  
>         try:
>             cart_item = CartItem.objects.get(id=item_id, cart__user=request.user)
!         except CartItem.DoesNotExist:
!             return Response({'error': 'Item not found'}, status=status.HTTP_404_NOT_FOUND)
  
>         if quantity == 0:
>             cart_item.delete()
>         else:
>             cart_item.quantity = quantity
>             cart_item.save()
  
>         cart, _ = Cart.objects.get_or_create(user=request.user)
>         serializer = CartSerializer(cart)
>         return Response(serializer.data)
  
>     @action(detail=False, methods=['post'])
>     def increment_item(self, request):
>         """Increment cart item quantity by 1."""
>         item_id = request.data.get('item_id')
>         try:
>             cart_item = CartItem.objects.get(id=item_id, cart__user=request.user)
!         except CartItem.DoesNotExist:
!             return Response({'error': 'Item not found'}, status=status.HTTP_404_NOT_FOUND)
  
>         cart_item.quantity += 1
>         cart_item.save()
  
>         cart, _ = Cart.objects.get_or_create(user=request.user)
>         serializer = CartSerializer(cart)
>         return Response(serializer.data)
  
>     @action(detail=False, methods=['post'])
>     def decrement_item(self, request):
>         """Decrement cart item quantity by 1. Deletes the item if it reaches 0."""
>         item_id = request.data.get('item_id')
>         try:
>             cart_item = CartItem.objects.get(id=item_id, cart__user=request.user)
!         except CartItem.DoesNotExist:
!             return Response({'error': 'Item not found'}, status=status.HTTP_404_NOT_FOUND)
  
>         cart_item.quantity -= 1
>         if cart_item.quantity <= 0:
>             cart_item.delete()
>         else:
>             cart_item.save()
  
>         cart, _ = Cart.objects.get_or_create(user=request.user)
>         serializer = CartSerializer(cart)
>         return Response(serializer.data)
      
>     @action(detail=False, methods=['post'])
>     def clear(self, request):
>         """Clear all items from cart."""
>         cart, _ = Cart.objects.get_or_create(user=request.user)
>         cart.items.all().delete()
>         serializer = CartSerializer(cart)
>         return Response(serializer.data)
