> from __future__ import annotations
  
> from django.conf import settings
> from opentelemetry import baggage
> from opentelemetry.context import attach, detach, get_current
  
  
> class TelemetryBaggageMiddleware:
>     """Attach useful baggage for correlation across services.
  
>     Adds:
>     - user.id (if authenticated)
>     - session.key (if available)
>     """
  
>     def __init__(self, get_response):
>         self.get_response = get_response
  
>     def __call__(self, request):
>         if not getattr(settings, "OTEL_ENABLED", True):
>             return self.get_response(request)
  
>         values: dict[str, str] = {}
  
>         user = getattr(request, "user", None)
>         if user is not None and getattr(user, "is_authenticated", False):
>             values["user.id"] = str(getattr(user, "id", ""))
  
>         session = getattr(request, "session", None)
>         if session is not None:
>             session_key = getattr(session, "session_key", None)
>             if session_key:
>                 values["session.key"] = str(session_key)
  
>         if not values:
>             return self.get_response(request)
  
>         ctx = get_current()
>         for k, v in values.items():
>             ctx = baggage.set_baggage(k, v, context=ctx)
  
>         token = attach(ctx)
>         try:
>             return self.get_response(request)
>         finally:
>             detach(token)
